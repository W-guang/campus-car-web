<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>首页 - 校园车辆管理系统</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css">
  <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=a49a852abb90dd6856b2d10227220702&plugin=AMap.Geocoder"></script>
  <style>
    .navbar-brand {
      font-size: 1.8rem !important;
      font-weight: bold;
      pointer-events: none;
      cursor: default;
    }
    .nav-link {
      font-size: 1.1rem;
      margin: 0 8px;
    }
    #map-container {
      width: 100%;
      height: 70vh;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .stat-card {
      background-color: #fff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .stat-card h6 {
      color: #666;
      margin-bottom: 10px;
    }
    .stat-card .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #4299e1;
    }
    .vehicle-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 15px;
      margin-bottom: 15px;
    }
    .filter {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <!-- 登录页 -->
  <div id="auth-page" class="auth-container">
    <div class="auth-card">
      <h2>校园车辆管理系统</h2>
      <input type="text" id="login-student-id" placeholder="学号">
      <input type="password" id="login-password" placeholder="密码">
      <button onclick="login()" class="btn-primary">登录</button>
      <p><a href="#" onclick="showRegister()">没有账号？去注册</a></p>
    </div>
  </div>

  <!-- 注册页 -->
  <div id="register-page" class="auth-container" style="display:none;">
    <div class="auth-card">
      <h2>注册</h2>
      <input type="text" id="reg-student-id" placeholder="学号">
      <input type="text" id="reg-name" placeholder="姓名">
      <input type="password" id="reg-password" placeholder="密码">
      <button onclick="register()" class="btn-primary">注册</button>
      <p><a href="#" onclick="showLogin()">返回登录</a></p>
    </div>
  </div>

  <!-- 主页 -->
  <div id="main-page" style="display:none;">
    <!-- 头部导航 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 shadow-sm">
      <div class="container">
        <a class="navbar-brand text-primary" href="/index.html">校园车辆管理系统</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link active text-dark" href="/index.html">首页</a></li>
            <li class="nav-item"><a class="nav-link text-dark" href="/carRent.html">租车</a></li>
            <li class="nav-item"><a class="nav-link text-dark" href="/forum.html">论坛</a></li>
            <li class="nav-item"><a class="nav-link text-dark" href="/blacklist.html">黑名单</a></li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle text-primary" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                个人中心
              </a>
              <ul class="dropdown-menu dropdown-menu-end" id="userMenu">
                <li><a class="dropdown-item" href="/login.html">请先登录</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <!-- 用户内容 -->
      <section id="user-content" style="display:none;">
        <div class="row">
          <!-- 左侧地图（占8列） -->
          <div class="col-lg-8">
            <h5 class="mb-3 text-dark">校园车辆分布地图</h5>
            <div class="filter">
              <label><input type="checkbox" id="filter-ebike" checked> 电动车</label>
              <label><input type="checkbox" id="filter-bicycle" checked> 自行车</label>
              <label>价格：¥<input type="number" id="min-price" value="0" min="0" step="0.5"> - ¥<input type="number" id="max-price" value="10" min="0" step="0.5"></label>
              <button onclick="applyFilter()" class="btn btn-primary">筛选</button>
            </div>
            <div id="map-container"></div>
          </div>
          <!-- 右侧统计（占4列） -->
          <div class="col-lg-4">
            <h5 class="mb-3 text-dark">系统实时统计</h5>
            <div class="stat-card">
              <h6>当前可租车辆</h6>
              <div class="stat-value" id="carCount">0</div>
            </div>
            <div class="stat-card">
              <h6>今日租车订单</h6>
              <div class="stat-value" id="orderCount">0</div>
            </div>
            <div class="stat-card">
              <h6>今日新发布车辆</h6>
              <div class="stat-value" id="todayRegisterCount">0</div>
            </div>
          </div>
        </div>

        <section class="vehicles mt-4">
          <h2>可租车辆</h2>
          <div id="vehicle-list">加载中...</div>
        </section>
      </section>

      <!-- 我的出租面板 -->
      <section id="my-rentals-panel" style="display:none; margin:20px 0;">
        <h2>
          我的出租车辆 
          <button onclick="backToHome()" class="btn btn-secondary" style="float:right; font-size:14px; padding:4px 8px;">返回</button>
        </h2>
        <div id="my-rentals-list">加载中...</div>
      </section>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentUser = null;
    let allVehicles = [];
    let map, geocoder;

    function showLogin() { document.getElementById('auth-page').style.display = 'block'; document.getElementById('register-page').style.display = 'none'; document.getElementById('main-page').style.display = 'none'; }
    function showRegister() { document.getElementById('auth-page').style.display = 'none'; document.getElementById('register-page').style.display = 'block'; document.getElementById('main-page').style.display = 'none'; }
    function showMain() { document.getElementById('auth-page').style.display = 'none'; document.getElementById('register-page').style.display = 'none'; document.getElementById('main-page').style.display = 'block'; }

    // 页面加载时检查登录状态
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('token');
      const userInfo = JSON.parse(localStorage.getItem('userInfo') || 'null');
      const user_id = localStorage.getItem('user_id');
      
      if (token && userInfo && user_id) {
        // 已登录，恢复用户信息
        currentUser = {
          user_id: parseInt(user_id),
          student_id: userInfo.studentId || userInfo.account,
          name: userInfo.name,
          role: userInfo.role === 'admin' ? 'admin' : 'student'
        };
        
        // 管理员直接跳转到后台
        if (currentUser.role === 'admin') {
          window.location.href = '/admin.html';
          return;
        }
        
        // 普通用户显示主页
        showMain();
        initUserMenu();
        setTimeout(() => {
          initMap();
          loadVehicles();
        }, 100);
      } else {
        // 未登录，显示登录页
        showLogin();
      }
    });

    // 初始化个人中心菜单
    function initUserMenu() {
      const userInfo = currentUser ? { role: currentUser.role === 'admin' ? 'admin' : 'user', studentId: currentUser.student_id, name: currentUser.name } : null;
      const menuElement = document.getElementById("userMenu");
      if (!userInfo) return;

      menuElement.innerHTML = "";
      if (userInfo.role === "user") {
        menuElement.innerHTML = `
          <li><a class="dropdown-item" href="/personalInfo.html">个人信息</a></li>
          <li><a class="dropdown-item" href="/rent.html">车辆发布</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" onclick="logout()">退出登录</a></li>
        `;
      } else if (userInfo.role === "admin") {
        menuElement.innerHTML = `
          <li><a class="dropdown-item" href="/personalInfo.html">个人信息</a></li>
          <li><a class="dropdown-item" href="/admin.html">管理员后台</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" onclick="logout()">退出登录</a></li>
        `;
      }
    }

    // 加载统计数据（从数据库获取）
    async function loadStatData() {
      try {
        const res = await fetch('/api/stats');
        const data = await res.json();
        if (res.ok) {
          updateStatValue("carCount", data.carCount || 0);
          updateStatValue("orderCount", data.todayOrderCount || 0);
          updateStatValue("todayRegisterCount", data.todayVehicleCount || 0);
        }
      } catch (error) {
        console.error('加载统计数据失败:', error);
        // 如果API失败，至少显示车辆数量
        if (allVehicles.length > 0) {
          updateStatValue("carCount", allVehicles.length);
        }
      }
    }

    function updateStatValue(id, target) {
      const element = document.getElementById(id);
      if (!element) return;
      let current = 0;
      const step = Math.ceil(target / 50);
      const timer = setInterval(() => {
        current += step;
        if (current >= target) {
          current = target;
          clearInterval(timer);
        }
        element.textContent = current;
      }, 30);
    }

    // 登录
    async function login() {
      const student_id = document.getElementById('login-student-id').value;
      const password = document.getElementById('login-password').value;
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ student_id, password })
      });
      const data = await res.json();
      if (res.ok) {
        currentUser = data.user;
        localStorage.setItem('user_id', data.user.user_id);
        localStorage.setItem('token', 'user_' + data.user.user_id);
        localStorage.setItem('userInfo', JSON.stringify({
          role: data.user.role === 'admin' ? 'admin' : 'user',
          studentId: data.user.student_id,
          name: data.user.name,
          user_id: data.user.user_id
        }));
        // 管理员直接跳转到后台
        if (data.user.role === 'admin') {
          window.location.href = '/admin.html';
        } else {
          // 普通用户显示主页
          showMain();
          initUserMenu();
          setTimeout(() => {
            initMap();
            loadVehicles();
          }, 100);
        }
      } else {
        alert(data.msg);
      }
    }

    // 注册
    async function register() {
      const student_id = document.getElementById('reg-student-id').value;
      const name = document.getElementById('reg-name').value;
      const password = document.getElementById('reg-password').value;
      const res = await fetch('/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ student_id, name, password })
      });
      const data = await res.json();
      alert(data.msg);
      if (res.ok) showLogin();
    }

    // 退出
    function logout() {
      if (confirm("确定要退出登录吗？")) {
        currentUser = null;
        localStorage.removeItem('user_id');
        localStorage.removeItem('token');
        localStorage.removeItem('userInfo');
        showLogin();
      }
    }

    // 初始化地图
    function initMap() {
      const container = document.getElementById('map-container');
      if (!container || typeof AMap === 'undefined') {
        setTimeout(initMap, 500);
        return;
      }
      map = new AMap.Map(container, {
        zoom: 16,
        center: [112.58451, 37.79676],
        resizeEnable: true
      });
      geocoder = new AMap.Geocoder();
    }

    // 加载车辆
    function loadVehicles() {
      fetch('/api/vehicles')
        .then(r => r.json())
        .then(vehicles => {
          allVehicles = vehicles;
          renderVehicles(vehicles);
          updateMapMarkers(vehicles);
          loadStatData(); // 加载统计数据
        });
    }

    // 渲染列表
    function renderVehicles(vehicles) {
      document.getElementById('vehicle-list').innerHTML = vehicles.map(v => `
        <div class="vehicle-card">
          <h3>${v.type === 'ebike' ? '电动车' : '自行车'}</h3>
          <p>位置：${v.location_desc}</p>
          <p>价格：¥${v.price_per_hour}/小时</p>
          <p>车主：${v.owner_name}</p>
          <button onclick="rentVehicle(${v.vehicle_id})" class="btn-rent">租用</button>
        </div>
      `).join('') || '<p>暂无车辆</p>';
    }

    // 更新地图标记
    function updateMapMarkers(vehicles) {
      if (!map) return;
      map.clearMap();
      vehicles.forEach(v => {
        const lnglat = v.lng && v.lat ? [parseFloat(v.lng), parseFloat(v.lat)] : [
          112.58451 + (Math.random() - 0.5) * 0.01,
          37.79676 + (Math.random() - 0.5) * 0.01
        ];

        const marker = new AMap.Marker({
          position: lnglat,
          title: v.location_desc,
          icon: 'https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png',
          label: { content: `¥${v.price_per_hour}`, direction: 'top' }
        });

        marker.on('click', () => {
          new AMap.InfoWindow({
            content: `
              <div style="padding:10px;">
                <h4>${v.type === 'ebike' ? '电动车' : '自行车'}</h4>
                <p><strong>位置：</strong>${v.location_desc}</p>
                <p><strong>价格：</strong>¥${v.price_per_hour}/小时</p>
                <p><strong>车主：</strong>${v.owner_name}</p>
                <button onclick="rentVehicle(${v.vehicle_id})" style="margin-top:8px; padding:6px 12px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer;">
                  立即租用
                </button>
              </div>
            `,
            offset: new AMap.Pixel(0, -30)
          }).open(map, lnglat);
        });

        marker.setMap(map);
      });
    }

    // 筛选
    window.applyFilter = function() {
      const ebike = document.getElementById('filter-ebike').checked;
      const bicycle = document.getElementById('filter-bicycle').checked;
      const min = parseFloat(document.getElementById('min-price').value) || 0;
      const max = parseFloat(document.getElementById('max-price').value) || Infinity;

      const filtered = allVehicles.filter(v => {
        const typeMatch = (ebike && v.type === 'ebike') || (bicycle && v.type === 'bicycle');
        const priceMatch = v.price_per_hour >= min && v.price_per_hour <= max;
        return typeMatch && priceMatch;
      });

      renderVehicles(filtered);
      updateMapMarkers(filtered);
    };

    // 租用
    window.rentVehicle = function(id) {
      if (!currentUser) {
        alert('请先登录');
        window.location.href = '/login.html';
        return;
      }
      window.location.href = `/carRent.html?vehicle_id=${id}`;
    };

    // 显示我的出租
// 显示我的出租（优化：撤回后显示“删除记录”）
// 显示我的出租（优化：排序 + 删除后消失）
async function showMyRentals() {
  document.getElementById('user-content').style.display = 'none';
  document.getElementById('my-rentals-panel').style.display = 'block';

  const user_id = localStorage.getItem('user_id');
  if (!user_id) {
    alert('请先登录');
    backToHome();
    return;
  }

  const res = await fetch('/api/my-rentals?user_id=' + user_id);
  let vehicles = await res.json();

  // 排序：1.已上架 2.待审核 3.已撤回
  vehicles.sort((a, b) => {
    const status = { 1: 0, 0: 1, '-1': 2 };
    return status[a.is_verified] - status[b.is_verified];
  });

  document.getElementById('my-rentals-list').innerHTML = vehicles.map(v => {
    const isWithdrawn = v.is_verified === -1;
    return `
      <div class="vehicle-card" style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h3>${v.type === 'ebike' ? '电动车' : '自行车'}</h3>
          <p>位置：${v.location_desc}</p>
          <p>价格：¥${v.price_per_hour}/小时</p>
          <p>状态：<span style="color:${
            v.is_verified === 1 ? '#28a745' : 
            v.is_verified === 0 ? '#ffc107' : '#dc3545'
          }">
            ${v.is_verified === 1 ? '已上架' : v.is_verified === 0 ? '待审核' : '已撤回'}
          </span></p>
        </div>
        <button onclick="${
          isWithdrawn ? `deleteVehicle(${v.vehicle_id})` : `withdrawVehicle(${v.vehicle_id})`
        }" 
                class="btn-${isWithdrawn ? 'danger' : 'logout'}" 
                style="height:40px; padding:6px 12px;">
          ${isWithdrawn ? '删除记录' : '撤回'}
        </button>
      </div>
    `;
  }).join('') || '<p>你还没有出租车辆</p>';
}

    // 撤回车辆
    async function withdrawVehicle(id) {
      if (!confirm('确定要撤回这辆车吗？')) return;

      const res = await fetch('/api/withdraw', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('user_id')
        },
        body: JSON.stringify({ vehicle_id: id })
      });
      const data = await res.json();
      alert(data.msg);
      if (res.ok) {
        showMyRentals();
        loadVehicles();
      }
    }

// 删除记录（已优化）
async function deleteVehicle(id) {
  if (!confirm('确定要彻底删除这条记录吗？（不可恢复）')) return;

  const res = await fetch('/api/delete-vehicle', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + localStorage.getItem('user_id')
    },
    body: JSON.stringify({ vehicle_id: id })
  });
  const data = await res.json();
  alert(data.msg);
  if (res.ok) {
    showMyRentals(); // 重新加载，删除项消失
  }
}

    // 返回主页
    function backToHome() {
      document.getElementById('my-rentals-panel').style.display = 'none';
      document.getElementById('user-content').style.display = 'block';
    }

    // 启动逻辑已移到DOMContentLoaded中
  </script>
</body>
</html>