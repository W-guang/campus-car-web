<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心 - 校园车辆管理系统</title>
    <!-- 引入依赖 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 导航栏样式（与首页保持一致） */
        .navbar-brand {
            font-size: 1.8rem !important;
            font-weight: bold;
            pointer-events: none;
            cursor: default;
        }
        .nav-link {
            font-size: 1.1rem;
            margin: 0 8px;
        }
        /* 个人中心主体样式 */
        .profile-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f1f5f9;
        }
        .profile-title {
            font-size: 1.5rem;
            color: #1e293b;
            font-weight: 500;
        }
        .btn-edit {
            background-color: #4299e1;
            color: #fff;
            border: none;
            padding: 6px 16px;
            font-size: 0.9rem;
        }
        .btn-edit:hover {
            background-color: #3182ce;
            color: #fff;
        }
        /* 个人信息表单样式 */
        .profile-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-label {
            font-size: 0.95rem;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .form-control {
            border-color: #e2e8f0;
            border-radius: 6px;
            padding: 10px 12px;
        }
        .form-control:disabled {
            background-color: #f8fafc;
            color: #1e293b;
            cursor: default;
        }
        /* 角色专属功能区样式 */
        .role-features {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 20px;
        }
        .feature-title {
            font-size: 1.1rem;
            color: #1e293b;
            margin-bottom: 15px;
            font-weight: 500;
        }
        .feature-card {
            background-color: #fff;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .feature-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e8f4f8;
            color: #4299e1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .feature-info {
            flex: 1;
        }
        .feature-name {
            font-size: 1rem;
            color: #1e293b;
            font-weight: 500;
            margin-bottom: 3px;
        }
        .feature-desc {
            font-size: 0.85rem;
            color: #94a3b8;
        }
        .btn-feature {
            color: #4299e1;
            background-color: transparent;
            border: 1px solid #4299e1;
            padding: 5px 12px;
            font-size: 0.85rem;
        }
        .btn-feature:hover {
            color: #fff;
            background-color: #4299e1;
        }
        /* 编辑信息模态框样式 */
        .modal-header {
            background-color: #e8f4f8;
        }
        .modal-footer {
            gap: 10px;
        }
        /* 订单标签页样式 */
        .order-tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0;
        }
        .order-tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 1rem;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }
        .order-tab:hover {
            color: #4299e1;
        }
        .order-tab.active {
            color: #4299e1;
            font-weight: 500;
        }
        .order-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #4299e1;
        }
        .order-list {
            min-height: 300px;
        }
        .order-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .order-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .order-id {
            font-weight: 500;
            color: #333;
        }
        .order-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .order-status.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .order-status.confirmed {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .order-status.completed {
            background-color: #d4edda;
            color: #155724;
        }
        .order-status.cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }
        .order-body {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        .order-info-item {
            font-size: 0.9rem;
            color: #666;
        }
        .order-info-item strong {
            color: #333;
        }
        .order-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .order-actions .btn {
            font-size: 0.85rem;
            padding: 5px 15px;
        }
        .contact-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- 头部导航（与首页一致） -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 shadow-sm">
        <div class="container">
            <a class="navbar-brand text-primary" href="/index.html">校园车辆管理系统</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link text-dark" href="/index.html">首页</a></li>
                    <li class="nav-item"><a class="nav-link text-dark" href="/carRent.html">租车</a></li>
                    <li class="nav-item"><a class="nav-link text-dark" href="/forum.html">论坛</a></li>
                    <li class="nav-item"><a class="nav-link text-dark" href="/blacklist.html">黑名单</a></li>
                </ul>
                <!-- 个人中心下拉框（当前页，默认选中） -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-primary" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            个人中心
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" id="userMenu">
                            <li><a class="dropdown-item" href="/login.html">请先登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主体内容（个人信息+角色专属功能） -->
    <div class="container">
        <div class="profile-container">
            <!-- 个人中心头部（标题+编辑按钮） -->
            <div class="profile-header">
                <h5 class="profile-title">个人信息</h5>
                <div>
                    <button type="button" class="btn btn-edit me-2" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                        修改密码
                    </button>
                    <button type="button" class="btn btn-edit" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                        编辑信息
                    </button>
                </div>
            </div>

            <!-- 个人信息表单（默认禁用，仅展示） -->
            <form class="profile-form" id="profileForm">
                <div class="form-group">
                    <label class="form-label">用户角色</label>
                    <input type="text" class="form-control" id="userRole" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">账号</label>
                    <input type="text" class="form-control" id="userAccount" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">姓名</label>
                    <input type="text" class="form-control" id="userName" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">手机号</label>
                    <input type="tel" class="form-control" id="userPhone" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">账号状态</label>
                    <input type="text" class="form-control" id="userStatus" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">注册时间</label>
                    <input type="text" class="form-control" id="registerTime" disabled>
                </div>
            </form>

            <!-- 角色专属功能区（普通用户/管理员差异化显示） -->
            <div class="role-features" id="roleFeaturesContainer">
                <!-- 功能区内容通过JS动态生成 -->
            </div>
        </div>
    </div>

    <!-- 编辑个人信息模态框 -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑个人信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form class="profile-form" id="editProfileForm">
                        <div class="form-group">
                            <label class="form-label">用户角色（不可修改）</label>
                            <input type="text" class="form-control" id="editUserRole" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">账号（不可修改）</label>
                            <input type="text" class="form-control" id="editUserAccount" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">姓名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editUserName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">手机号 <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="editUserPhone" placeholder="请输入11位手机号" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">账号状态（不可修改）</label>
                            <input type="text" class="form-control" id="editUserStatus" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">注册时间（不可修改）</label>
                            <input type="text" class="form-control" id="editRegisterTime" disabled>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitEditBtn">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改密码模态框 -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改密码</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">当前密码 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="currentPassword" placeholder="请输入当前密码" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">新密码 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="newPassword" placeholder="请输入新密码（至少6位）" required>
                            <div class="form-text">密码长度至少6位</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">确认新密码 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="confirmPassword" placeholder="请再次输入新密码" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitChangePasswordBtn">确认修改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加管理员模态框 -->
    <div class="modal fade" id="addAdminModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #e8f4f8;">
                    <h5 class="modal-title">添加管理员</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addAdminForm">
                        <div class="mb-3">
                            <label for="adminStudentId" class="form-label">学号 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="adminStudentId" placeholder="请输入学号" required>
                        </div>
                        <div class="mb-3">
                            <label for="adminName" class="form-label">姓名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="adminName" placeholder="请输入姓名" required>
                        </div>
                        <div class="mb-3">
                            <label for="adminPhone" class="form-label">手机号</label>
                            <input type="tel" class="form-control" id="adminPhone" placeholder="请输入手机号">
                        </div>
                        <div class="mb-3">
                            <label for="adminPassword" class="form-label">密码 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="adminPassword" placeholder="请设置密码" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitAddAdminBtn">提交</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // 1. 强制登录校验（未登录直接跳转）
            const token = localStorage.getItem("token");
            const userInfo = JSON.parse(localStorage.getItem("userInfo"));
            if (!token || !userInfo) {
                alert("请先登录后访问个人中心");
                window.location.href = "/login.html";
                return;
            }

            // 2. 初始化个人中心菜单（当前页，默认选中个人信息）
            initUserMenu();
            // 3. 加载个人信息（区分普通用户/管理员）
            loadProfileInfo(userInfo);
            // 4. 加载角色专属功能区
            loadRoleFeatures(userInfo);
            // 5. 绑定编辑信息事件
            bindEditProfile(userInfo);
            // 6. 绑定修改密码事件
            bindChangePassword(userInfo);
            // 7. 绑定添加管理员事件（仅管理员）
            if (userInfo.role === "admin") {
                bindAddAdmin();
            }
        });

        // 初始化个人中心菜单（当前页高亮）
        function initUserMenu() {
            const userInfo = JSON.parse(localStorage.getItem("userInfo"));
            const menuElement = document.getElementById("userMenu");
            if (!userInfo) return;

            menuElement.innerHTML = "";
            if (userInfo.role === "user") {
                // 普通用户菜单（当前页“个人信息”默认选中）
                menuElement.innerHTML = `
                    <li><a class="dropdown-item active" href="/personalInfo.html">个人信息</a></li>
                    <li><a class="dropdown-item" href="/rent.html">车辆发布</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="logoutBtn">退出登录</a></li>
                `;
            } else if (userInfo.role === "admin") {
                // 管理员菜单（当前页“个人信息”默认选中）
                menuElement.innerHTML = `
                    <li><a class="dropdown-item active" href="/personalInfo.html">个人信息</a></li>
                    <li><a class="dropdown-item" href="/admin.html">管理员后台</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="logoutBtn">退出登录</a></li>
                `;
            }

            // 退出登录事件
            document.getElementById("logoutBtn")?.addEventListener("click", () => {
                if (confirm("确定要退出登录吗？")) {
                    localStorage.removeItem("token");
                    localStorage.removeItem("userInfo");
                    window.location.href = "/login.html";
                }
            });
        }

        // 加载个人信息（填充表单）
        function loadProfileInfo(userInfo) {
            // 模拟用户完整信息（实际需调用后端接口获取）
            const fullProfile = getFullProfile(userInfo);

            // 填充展示用表单
            document.getElementById("userRole").value = fullProfile.roleText;
            document.getElementById("userAccount").value = fullProfile.account;
            document.getElementById("userName").value = fullProfile.name;
            document.getElementById("userPhone").value = fullProfile.phone;
            document.getElementById("userStatus").value = fullProfile.statusText;
            document.getElementById("registerTime").value = fullProfile.registerTime;

            // 填充编辑用表单（初始值与展示表单一致）
            document.getElementById("editUserRole").value = fullProfile.roleText;
            document.getElementById("editUserAccount").value = fullProfile.account;
            document.getElementById("editUserName").value = fullProfile.name;
            document.getElementById("editUserPhone").value = fullProfile.phone;
            document.getElementById("editUserStatus").value = fullProfile.statusText;
            document.getElementById("editRegisterTime").value = fullProfile.registerTime;
        }

        // 加载角色专属功能区（差异化显示）
        function loadRoleFeatures(userInfo) {
            const featuresContainer = document.getElementById("roleFeaturesContainer");
            if (userInfo.role === "user") {
                // 普通用户功能区：车辆发布 + 订单管理
                featuresContainer.innerHTML = `
                    <h5 class="feature-title">我的功能</h5>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="bi bi-bicycle"></i>
                        </div>
                        <div class="feature-info">
                            <div class="feature-name">车辆发布</div>
                            <div class="feature-desc">发布您的自行车/电动车，共享给其他同学使用</div>
                        </div>
                        <button class="btn btn-feature" onclick="window.location.href='/rent.html'">去发布</button>
                    </div>
                    
                    <!-- 我的租车订单区域 -->
                    <h5 class="feature-title mt-4">我的租车订单</h5>
                    <div class="order-tabs mb-3">
                        <button class="order-tab active" id="rentedTab">我租的车</button>
                        <button class="order-tab" id="ownedTab">租我车的</button>
                        <button class="order-tab" id="historyTab">历史记录</button>
                    </div>
                    <div id="orderListContainer" class="order-list">
                        <!-- 订单列表通过JS动态加载 -->
                    </div>
                `;
                
                // 初始化订单标签切换
                initOrderTabs();
                // 加载我租的车订单
                loadMyOrders('rented');
            } else if (userInfo.role === "admin") {
                // 管理员功能区：管理员后台
                featuresContainer.innerHTML = `
                    <h5 class="feature-title">管理员功能</h5>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="bi bi-shield-fill"></i>
                        </div>
                        <div class="feature-info">
                            <div class="feature-name">管理员后台</div>
                            <div class="feature-desc">审核用户/车辆/帖子，处理举报，查看系统数据</div>
                        </div>
                        <button class="btn btn-feature" onclick="window.location.href='/admin.html'">进入后台</button>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="bi bi-person-plus"></i>
                        </div>
                        <div class="feature-info">
                            <div class="feature-name">添加管理员</div>
                            <div class="feature-desc">创建新的管理员账号</div>
                        </div>
                        <button class="btn btn-feature" data-bs-toggle="modal" data-bs-target="#addAdminModal">添加管理员</button>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="bi bi-clipboard-x"></i>
                        </div>
                        <div class="feature-info">
                            <div class="feature-name">黑名单管理</div>
                            <div class="feature-desc">查看/管理黑名单用户，处理违规账号</div>
                        </div>
                        <button class="btn btn-feature" onclick="window.location.href='/blacklist.html'">去管理</button>
                    </div>
                `;
            }
        }

        // 绑定编辑个人信息事件
        function bindEditProfile(userInfo) {
            const submitEditBtn = document.getElementById("submitEditBtn");
            const editProfileModal = new bootstrap.Modal(document.getElementById("editProfileModal"));
            const editUserName = document.getElementById("editUserName");
            const editUserPhone = document.getElementById("editUserPhone");

            // 保存修改逻辑
            submitEditBtn.addEventListener("click", async () => {
                const newName = editUserName.value.trim();
                const newPhone = editUserPhone.value.trim();

                // 表单校验
                if (!newName) {
                    alert("请输入姓名");
                    return;
                }
                if (!/^1[3-9]\d{9}$/.test(newPhone)) {
                    alert("请输入正确的11位手机号");
                    return;
                }

                // 调用后端接口更新数据库
                try {
                    const user_id = localStorage.getItem('user_id');
                    if (!user_id) {
                        alert('请先登录');
                        window.location.href = '/login.html';
                        return;
                    }

                    const res = await fetch('/api/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + user_id
                        },
                        body: JSON.stringify({
                            name: newName,
                            phone: newPhone
                        })
                    });
                    const result = await res.json();

                    if (res.ok) {
                        // 1. 更新本地存储的用户信息
                        userInfo.name = newName;
                        userInfo.phone = newPhone;
                        localStorage.setItem("userInfo", JSON.stringify(userInfo));

                        // 2. 更新页面展示的信息
                        document.getElementById("userName").value = newName;
                        document.getElementById("userPhone").value = newPhone;

                        // 3. 提示并关闭模态框
                        alert("个人信息修改成功！数据已保存到数据库");
                        editProfileModal.hide();
                    } else {
                        alert(result.msg || '保存失败，请稍后重试');
                    }
                } catch (error) {
                    console.error('保存失败:', error);
                    alert('保存失败：' + (error.message || '请检查网络连接'));
                }
            });
        }

        // 绑定修改密码事件
        function bindChangePassword(userInfo) {
            const submitChangePasswordBtn = document.getElementById("submitChangePasswordBtn");
            const changePasswordModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("changePasswordModal"));
            const currentPassword = document.getElementById("currentPassword");
            const newPassword = document.getElementById("newPassword");
            const confirmPassword = document.getElementById("confirmPassword");

            submitChangePasswordBtn.addEventListener("click", async () => {
                const currentPwd = currentPassword.value;
                const newPwd = newPassword.value;
                const confirmPwd = confirmPassword.value;

                // 表单校验
                if (!currentPwd || !newPwd || !confirmPwd) {
                    alert("请填写所有密码字段");
                    return;
                }

                if (newPwd.length < 6) {
                    alert("新密码长度至少6位");
                    return;
                }

                if (newPwd !== confirmPwd) {
                    alert("两次输入的新密码不一致");
                    return;
                }

                if (currentPwd === newPwd) {
                    alert("新密码不能与当前密码相同");
                    return;
                }

                // 调用后端API修改密码
                try {
                    const user_id = localStorage.getItem('user_id');
                    if (!user_id) {
                        alert('请先登录');
                        window.location.href = '/login.html';
                        return;
                    }

                    const res = await fetch('/api/change-password', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + user_id
                        },
                        body: JSON.stringify({
                            currentPassword: currentPwd,
                            newPassword: newPwd
                        })
                    });
                    const result = await res.json();

                    if (res.ok) {
                        alert("密码修改成功！请使用新密码重新登录");
                        changePasswordModal.hide();
                        document.getElementById("changePasswordForm").reset();
                        // 清除登录状态，跳转到登录页
                        localStorage.removeItem("token");
                        localStorage.removeItem("userInfo");
                        localStorage.removeItem("user_id");
                        window.location.href = "/login.html";
                    } else {
                        alert(result.msg || '修改失败，请稍后重试');
                    }
                } catch (error) {
                    console.error('修改密码失败:', error);
                    alert('修改失败：' + (error.message || '请检查网络连接'));
                }
            });
        }

        // 绑定添加管理员事件
        function bindAddAdmin() {
            const submitAddAdminBtn = document.getElementById("submitAddAdminBtn");
            const addAdminModal = new bootstrap.Modal(document.getElementById("addAdminModal"));

            submitAddAdminBtn.addEventListener("click", async () => {
                const studentId = document.getElementById("adminStudentId").value.trim();
                const name = document.getElementById("adminName").value.trim();
                const phone = document.getElementById("adminPhone").value.trim();
                const password = document.getElementById("adminPassword").value;

                if (!studentId || !name || !password) {
                    alert("请填写所有必填字段");
                    return;
                }

                try {
                    const user_id = localStorage.getItem('user_id');
                    const res = await fetch('/api/admin/add-admin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + user_id
                        },
                        body: JSON.stringify({
                            student_id: studentId,
                            name: name,
                            phone: phone || null,
                            password: password
                        })
                    });
                    const result = await res.json();

                    if (res.ok) {
                        alert('管理员账号创建成功！');
                        addAdminModal.hide();
                        document.getElementById("addAdminForm").reset();
                    } else {
                        alert(result.msg || '创建失败，请稍后重试');
                    }
                } catch (error) {
                    console.error('添加管理员失败:', error);
                    alert('添加失败：' + (error.message || '请检查网络连接'));
                }
            });
        }

        // 工具函数：获取完整用户信息（模拟后端返回）
        function getFullProfile(userInfo) {
            // 模拟注册时间（30天内随机）
            const registerDate = new Date();
            registerDate.setDate(registerDate.getDate() - Math.floor(Math.random() * 30));
            const registerTime = registerDate.toLocaleString("zh-CN", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit"
            });

            if (userInfo.role === "user") {
                // 普通用户完整信息
                return {
                    role: "user",
                    roleText: "普通用户",
                    account: userInfo.studentId || "user_123456",
                    name: userInfo.name || "普通用户",
                    phone: userInfo.phone || "138****5678",
                    status: "normal",
                    statusText: "正常（已通过审核）",
                    registerTime: registerTime
                };
            } else if (userInfo.role === "admin") {
                // 管理员完整信息
                return {
                    role: "admin",
                    roleText: "管理员",
                    account: userInfo.account || "admin_001",
                    name: userInfo.name || "系统管理员",
                    phone: userInfo.phone || "139****8901",
                    status: "normal",
                    statusText: "管理员账号",
                    registerTime: registerTime
                };
            }
        }

        // 初始化订单标签切换
        function initOrderTabs() {
            const rentedTab = document.getElementById('rentedTab');
            const ownedTab = document.getElementById('ownedTab');
            const historyTab = document.getElementById('historyTab');

            rentedTab?.addEventListener('click', () => {
                setActiveTab('rentedTab');
                loadMyOrders('rented');
            });

            ownedTab?.addEventListener('click', () => {
                setActiveTab('ownedTab');
                loadMyOrders('owned');
            });

            historyTab?.addEventListener('click', () => {
                setActiveTab('historyTab');
                loadMyOrders('history');
            });
        }

        // 设置活动标签
        function setActiveTab(tabId) {
            document.querySelectorAll('.order-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId)?.classList.add('active');
        }

        // 加载我的订单
        async function loadMyOrders(type) {
            const container = document.getElementById('orderListContainer');
            const user_id = localStorage.getItem('user_id');

            if (!user_id) {
                container.innerHTML = '<p class="text-center text-muted mt-4">请先登录</p>';
                return;
            }

            container.innerHTML = '<p class="text-center text-muted mt-4">加载中...</p>';

            try {
                const res = await fetch(`/api/orders/my?type=${type}`, {
                    headers: {
                        'Authorization': 'Bearer ' + user_id
                    }
                });

                const orders = await res.json();

                if (!res.ok) {
                    container.innerHTML = `<p class="text-center text-danger mt-4">${orders.msg || '加载失败'}</p>`;
                    return;
                }

                if (orders.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted mt-4">暂无订单记录</p>';
                    return;
                }

                // 渲染订单列表
                container.innerHTML = orders.map(order => renderOrderCard(order, type)).join('');
            } catch (error) {
                console.error('加载订单失败', error);
                container.innerHTML = '<p class="text-center text-danger mt-4">加载失败：' + error.message + '</p>';
            }
        }

        // 渲染订单卡片
        function renderOrderCard(order, type) {
            const statusMap = {
                'pending': { text: '待确认', class: 'pending' },
                'confirmed': { text: '已确认', class: 'confirmed' },
                'completed': { text: '已完成', class: 'completed' },
                'cancelled': { text: '已取消', class: 'cancelled' }
            };

            const status = statusMap[order.status] || { text: order.status, class: 'pending' };
            const vehicleType = order.vehicle_type === 'ebike' ? '电动车' : '自行车';
            const createdAt = new Date(order.created_at).toLocaleString('zh-CN');
            const completedAt = order.completed_at ? new Date(order.completed_at).toLocaleString('zh-CN') : '-';

            // 根据订单类型显示不同的对方信息
            let contactPerson, contactPhone;
            if (type === 'rented') {
                // 我租的车，显示车主信息
                contactPerson = order.owner_name;
                contactPhone = order.owner_phone;
            } else if (type === 'owned') {
                // 租我车的，显示租客信息
                contactPerson = order.renter_name;
                contactPhone = order.renter_phone;
            }

            // 操作按钮
            let actionButtons = '';
            if (type === 'rented') {
                // 我租的车的操作
                if (order.status === 'confirmed') {
                    actionButtons = `
                        <button class="btn btn-success btn-sm" onclick="completeOrder(${order.order_id})">确认完成</button>
                        <button class="btn btn-danger btn-sm" onclick="cancelOrder(${order.order_id})">取消订单</button>
                    `;
                } else if (order.status === 'pending') {
                    actionButtons = `<button class="btn btn-secondary btn-sm" onclick="cancelOrder(${order.order_id})">取消订单</button>`;
                }
            } else if (type === 'owned') {
                // 租我车的操作
                if (order.status === 'pending') {
                    actionButtons = `
                        <button class="btn btn-primary btn-sm" onclick="confirmOrder(${order.order_id})">确认订单</button>
                        <button class="btn btn-danger btn-sm" onclick="cancelOrder(${order.order_id})">拒绝订单</button>
                    `;
                } else if (order.status === 'confirmed') {
                    actionButtons = `<button class="btn btn-success btn-sm" onclick="completeOrder(${order.order_id})">确认完成</button>`;
                }
            }

            // 历史记录不显示操作按钮
            if (type === 'history') {
                actionButtons = '';
            }

            return `
                <div class="order-card">
                    <div class="order-header">
                        <span class="order-id">订单号：${order.order_id}</span>
                        <span class="order-status ${status.class}">${status.text}</span>
                    </div>
                    <div class="order-body">
                        <div class="order-info-item">
                            <strong>车辆类型：</strong>${vehicleType}
                        </div>
                        <div class="order-info-item">
                            <strong>取车地点：</strong>${order.location_desc}
                        </div>
                        <div class="order-info-item">
                            <strong>租用时长：</strong>${order.hours} 小时
                        </div>
                        <div class="order-info-item">
                            <strong>费用：</strong><span class="text-danger fw-bold">¥${order.total_fee}</span>
                        </div>
                        <div class="order-info-item">
                            <strong>下单时间：</strong>${createdAt}
                        </div>
                        <div class="order-info-item">
                            <strong>完成时间：</strong>${completedAt}
                        </div>
                    </div>
                    ${contactPerson && contactPhone ? `
                        <div class="contact-info">
                            <strong>${type === 'rented' ? '车主' : '租客'}联系方式：</strong>
                            ${contactPerson} - ${contactPhone}
                        </div>
                    ` : ''}
                    ${actionButtons ? `
                        <div class="order-actions mt-3">
                            ${actionButtons}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // 车主确认订单
        async function confirmOrder(orderId) {
            if (!confirm('确认接受此订单？确认后租客将收到通知。')) {
                return;
            }

            const user_id = localStorage.getItem('user_id');
            try {
                const res = await fetch('/api/orders/confirm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + user_id
                    },
                    body: JSON.stringify({ order_id: orderId })
                });

                const result = await res.json();
                if (res.ok) {
                    alert('订单确认成功！');
                    loadMyOrders('owned'); // 刷新列表
                } else {
                    alert(result.msg || '确认失败');
                }
            } catch (error) {
                console.error('确认订单失败', error);
                alert('确认失败：' + error.message);
            }
        }

        // 完成订单（双方都可以操作）
        async function completeOrder(orderId) {
            if (!confirm('确认完成此订单？完成后订单将进入历史记录。')) {
                return;
            }

            const user_id = localStorage.getItem('user_id');
            try {
                const res = await fetch('/api/orders/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + user_id
                    },
                    body: JSON.stringify({ order_id: orderId })
                });

                const result = await res.json();
                if (res.ok) {
                    alert('订单已完成！感谢使用校园车辆共享服务。');
                    // 刷新当前标签
                    const activeTab = document.querySelector('.order-tab.active');
                    if (activeTab.id === 'rentedTab') {
                        loadMyOrders('rented');
                    } else if (activeTab.id === 'ownedTab') {
                        loadMyOrders('owned');
                    }
                } else {
                    alert(result.msg || '完成失败');
                }
            } catch (error) {
                console.error('完成订单失败', error);
                alert('完成失败：' + error.message);
            }
        }

        // 取消订单
        async function cancelOrder(orderId) {
            if (!confirm('确认取消此订单？此操作不可恢复。')) {
                return;
            }

            const user_id = localStorage.getItem('user_id');
            try {
                const res = await fetch('/api/orders/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + user_id
                    },
                    body: JSON.stringify({ order_id: orderId })
                });

                const result = await res.json();
                if (res.ok) {
                    alert('订单已取消');
                    // 刷新当前标签
                    const activeTab = document.querySelector('.order-tab.active');
                    if (activeTab.id === 'rentedTab') {
                        loadMyOrders('rented');
                    } else if (activeTab.id === 'ownedTab') {
                        loadMyOrders('owned');
                    }
                } else {
                    alert(result.msg || '取消失败');
                }
            } catch (error) {
                console.error('取消订单失败', error);
                alert('取消失败：' + error.message);
            }
        }
    </script>
    <!-- 引入Bootstrap图标 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</body>
</html>