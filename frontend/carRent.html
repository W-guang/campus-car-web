<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>租车 - 校园车辆管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/style.css">
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=a49a852abb90dd6856b2d10227220702&plugin=AMap.Geocoder"></script>
</head>
<body>
    <div class="gradient-bg">
        <div class="g-blob blob-1"></div>
        <div class="g-blob blob-2"></div>
        <div class="g-blob blob-3"></div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/index.html">校园车辆管理系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/index.html">首页</a></li>
                    <li class="nav-item"><a class="nav-link active text-primary fw-bold" href="/carRent.html">租车</a></li>
                    <li class="nav-item"><a class="nav-link" href="/forum.html">论坛</a></li>
                    <li class="nav-item"><a class="nav-link" href="/blacklist.html">黑名单</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-primary fw-bold" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            个人中心
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg" id="userMenu">
                            <li><a class="dropdown-item" href="/login.html">请先登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div style="height: 80px;"></div>

    <div class="container">
        <div class="dashboard-container">
            <!-- 筛选功能 -->
            <div class="filter p-3 mb-4 rounded-3 bg-light">
                <div class="row align-items-center g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold small text-muted mb-1">车辆类型</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="filter-ebike" checked>
                                <label class="form-check-label">电动车</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="filter-bicycle" checked>
                                <label class="form-check-label">自行车</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-muted mb-1">价格范围 (元/小时)</label>
                        <div class="input-group input-group-sm">
                            <input type="number" id="min-price" class="form-control" value="0" min="0" step="0.5" placeholder="最低">
                            <span class="input-group-text bg-white border-start-0 border-end-0">-</span>
                            <input type="number" id="max-price" class="form-control" value="10" min="0" step="0.5" placeholder="最高">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label d-none d-md-block">&nbsp;</label>
                        <button onclick="applyFilter()" class="btn btn-primary btn-sm w-100">筛选</button>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label d-none d-md-block">&nbsp;</label>
                        <button onclick="resetFilter()" class="btn btn-outline-secondary btn-sm w-100 border-0">重置</button>
                    </div>
                </div>
            </div>

            <div class="mode-tabs">
                <button class="mode-tab active" id="mapModeBtn"><i class="bi bi-map me-1"></i>地图模式</button>
                <button class="mode-tab" id="listModeBtn"><i class="bi bi-list-ul me-1"></i>列表模式</button>
            </div>

            <div id="rentMap"></div>

            <div class="car-list" id="carListContainer" style="display: none;">
                <!-- 列表内容由JS填充 -->
            </div>
        </div>
    </div>

    <!-- 租车Modal -->
    <div class="modal fade" id="rentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-light border-0">
                    <h5 class="modal-title fw-bold" id="rentModalTitle">租用车辆</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="rentCarId">
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <h6 class="mb-0 fw-bold" id="modalCarType">电动车</h6>
                            <span class="badge bg-primary bg-opacity-10 text-primary ms-2" id="modalCarPriceBadge"><span id="modalCarPrice">3</span>元/小时</span>
                        </div>
                        <div class="text-muted small">
                            <p class="mb-1"><i class="bi bi-geo-alt me-1"></i><span id="modalCarLocation">东区宿舍楼下</span></p>
                            <p class="mb-0"><i class="bi bi-person me-1"></i><span id="modalCarOwner">张**</span></p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="rentHours" class="form-label fw-bold small text-uppercase text-muted">租用时长</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="rentHours" min="1" max="6" value="2" required>
                            <span class="input-group-text">小时</span>
                        </div>
                        <div class="form-text small">建议租用 1-6 小时</div>
                    </div>
                    
                    <div class="fee-calculator">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">单价</span>
                            <span>¥<span id="calcPriceText">3</span>/小时</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">时长</span>
                            <span>x <span id="calcHours">2</span></span>
                        </div>
                        <div class="border-top pt-3 d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-dark">预计总费用</span>
                            <span class="fs-4 fw-bold text-primary">¥<span id="calcTotal">6</span></span>
                        </div>
                        <div class="text-center mt-2">
                            <span class="badge bg-warning bg-opacity-10 text-warning small fw-normal">线下支付</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light rounded-bottom-4">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary px-4" id="submitRentBtn">确认下单</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 订单成功Modal -->
    <div class="modal fade" id="orderSuccessModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-success text-white border-0">
                    <h5 class="modal-title"><i class="bi bi-check-circle-fill me-2"></i>预订成功</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="text-center mb-4">
                        <h4 class="fw-bold text-success">订单已提交</h4>
                        <p class="text-muted small">请联系车主取车</p>
                    </div>
                    
                    <div class="card border-0 bg-light mb-3">
                        <div class="card-body">
                            <div class="row g-2 small">
                                <div class="col-6 text-muted">订单号</div>
                                <div class="col-6 text-end fw-bold" id="successOrderId">-</div>
                                <div class="col-6 text-muted">车辆信息</div>
                                <div class="col-6 text-end fw-bold" id="successCarType">-</div>
                                <div class="col-6 text-muted">取车地点</div>
                                <div class="col-6 text-end fw-bold text-truncate" id="successLocation">-</div>
                                <div class="col-6 text-muted">预计费用</div>
                                <div class="col-6 text-end fw-bold text-danger">¥<span id="successFee">-</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-primary border-opacity-25 bg-primary bg-opacity-10">
                        <div class="card-body text-center">
                            <h6 class="text-primary fw-bold mb-1">车主联系方式</h6>
                            <div class="fs-4 fw-bold text-dark mb-1" id="successOwnerPhone">-</div>
                            <div class="small text-muted" id="successOwnerName">-</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light rounded-bottom-4">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="window.location.href='/personalInfo.html'">查看我的订单</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let map, markers = [];
        let allVehicles = []; // 保存所有车辆数据用于筛选
        
        document.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem("token");
            const userInfo = JSON.parse(localStorage.getItem("userInfo"));
            if (!token || !userInfo) {
                alert("请先登录后再租车");
                window.location.href = "/login.html";
                return;
            }

            initUserMenu();
            // 先加载所有车辆数据
            fetch('/api/vehicles')
                .then(r => r.json())
                .then(vehicles => {
                    allVehicles = vehicles;
                    initRentMap();
                    loadCarList();
                });
            bindModeSwitch();
            bindRentEvents();
        });

        // 筛选功能
        function applyFilter() {
            const ebike = document.getElementById('filter-ebike').checked;
            const bicycle = document.getElementById('filter-bicycle').checked;
            const min = parseFloat(document.getElementById('min-price').value) || 0;
            const max = parseFloat(document.getElementById('max-price').value) || Infinity;

            const filtered = allVehicles.filter(v => {
                const typeMatch = (ebike && v.type === 'ebike') || (bicycle && v.type === 'bicycle');
                const priceMatch = v.price_per_hour >= min && v.price_per_hour <= max;
                return typeMatch && priceMatch;
            });

            loadVehiclesOnMap(filtered);
            loadCarList(filtered);
        }

        // 重置筛选
        function resetFilter() {
            document.getElementById('filter-ebike').checked = true;
            document.getElementById('filter-bicycle').checked = true;
            document.getElementById('min-price').value = 0;
            document.getElementById('max-price').value = 10;
            loadVehiclesOnMap();
            loadCarList();
        }

        function initUserMenu() {
            const userInfo = JSON.parse(localStorage.getItem("userInfo"));
            const menuElement = document.getElementById("userMenu");
            if (!userInfo) return;

            menuElement.innerHTML = "";
            if (userInfo.role === "user") {
                menuElement.innerHTML = `
                    <li><a class="dropdown-item" href="/personalInfo.html">个人信息</a></li>
                    <li><a class="dropdown-item" href="/vehicleManage.html">车辆管理</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="logoutBtn">退出登录</a></li>
                `;
            } else if (userInfo.role === "admin") {
                menuElement.innerHTML = `
                    <li><a class="dropdown-item" href="/personalInfo.html">个人信息</a></li>
                    <li><a class="dropdown-item" href="/admin.html">管理界面</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="logoutBtn">退出登录</a></li>
                `;
            }

            document.getElementById("logoutBtn")?.addEventListener("click", () => {
                if (confirm("确定要退出登录吗？")) {
                    localStorage.removeItem("token");
                    localStorage.removeItem("userInfo");
                    window.location.href = "/login.html";
                }
            });
        }

        function initRentMap() {
            if (typeof AMap === 'undefined') {
                setTimeout(initRentMap, 500);
                return;
            }
            map = new AMap.Map("rentMap", {
                zoom: 16,
                center: [112.58451, 37.79676],
                resizeEnable: true
            });

            loadVehiclesOnMap();
        }

        function loadVehiclesOnMap(vehiclesToShow = null) {
            if (!map) return;
            map.clearMap();
            markers = [];

            const vehicles = vehiclesToShow || allVehicles;
            vehicles.forEach(v => {
                const lnglat = v.lng && v.lat ? [parseFloat(v.lng), parseFloat(v.lat)] : [
                    112.58451 + (Math.random() - 0.5) * 0.01,
                    37.79676 + (Math.random() - 0.5) * 0.01
                ];

                const marker = new AMap.Marker({
                    position: lnglat,
                    title: v.location_desc,
                    icon: 'https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png',
                    label: { content: '¥' + v.price_per_hour, direction: 'top' }
                });

                marker.on('click', () => {
                    new AMap.InfoWindow({
                        content: `
                            <div style="padding:10px; min-width: 200px;">
                                <h5 style="margin:0 0 8px; color:#667eea; font-weight:bold;">${v.type === 'ebike' ? '电动车' : '自行车'}</h5>
                                <p style="margin:0 0 5px; font-size:13px;"><span style="color:#999;">位置：</span>${v.location_desc}</p>
                                <p style="margin:0 0 5px; font-size:13px;"><span style="color:#999;">价格：</span><span style="color:#f56565; font-weight:bold;">¥${v.price_per_hour}</span>/小时</p>
                                <p style="margin:0 0 10px; font-size:13px;"><span style="color:#999;">车主：</span>${v.owner_name}</p>
                                <button class="btn btn-sm btn-primary w-100 rent-btn" 
                                        style="background:linear-gradient(135deg, #667eea, #764ba2); border:none; border-radius:20px;"
                                        data-id="${v.vehicle_id}" 
                                        data-type="${v.type === 'ebike' ? '电动车' : '自行车'}" 
                                        data-location="${v.location_desc}" 
                                        data-price="${v.price_per_hour}" 
                                        data-owner="${v.owner_name}">
                                    立即租用
                                </button>
                            </div>
                        `,
                        offset: new AMap.Pixel(0, -30)
                    }).open(map, lnglat);
                });

                marker.setMap(map);
                markers.push(marker);
            });
        }

        function loadCarList(vehiclesToShow = null) {
            const vehicles = vehiclesToShow || allVehicles;
            const listContainer = document.getElementById("carListContainer");
            listContainer.innerHTML = "";

            if (vehicles.length === 0) {
                listContainer.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-bicycle display-4 d-block mb-3 opacity-50"></i><p>暂无符合条件的车辆</p></div>';
                return;
            }

            vehicles.forEach(v => {
                const carCard = document.createElement("div");
                carCard.className = "car-card";
                carCard.innerHTML = `
                    <div class="d-flex align-items-center justify-content-center bg-light rounded-3" style="width:80px; height:80px;">
                        <i class="bi ${v.type === 'ebike' ? 'bi-lightning-charge' : 'bi-bicycle'} fs-1 text-primary"></i>
                    </div>
                    <div class="car-info">
                        <span class="car-type">${v.type === 'ebike' ? '电动车' : '自行车'}</span>
                        <h5 class="car-price mb-1">¥${v.price_per_hour}<small class="text-muted fw-normal fs-6">/小时</small></h5>
                        <p class="car-location mb-0"><i class="bi bi-geo-alt text-muted me-1"></i>${v.location_desc}</p>
                        <p class="car-owner mb-0"><i class="bi bi-person text-muted me-1"></i>${v.owner_name}</p>
                    </div>
                    <button class="btn btn-primary px-4 py-2 rounded-pill rent-btn" 
                            data-id="${v.vehicle_id}" 
                            data-type="${v.type === 'ebike' ? '电动车' : '自行车'}" 
                            data-location="${v.location_desc}" 
                            data-price="${v.price_per_hour}" 
                            data-owner="${v.owner_name}">
                        租车
                    </button>
                `;
                listContainer.appendChild(carCard);
            });
        }

        function bindModeSwitch() {
            const mapModeBtn = document.getElementById("mapModeBtn");
            const listModeBtn = document.getElementById("listModeBtn");
            const rentMap = document.getElementById("rentMap");
            const carList = document.getElementById("carListContainer");

            mapModeBtn.addEventListener("click", () => {
                mapModeBtn.classList.add("active");
                listModeBtn.classList.remove("active");
                rentMap.style.display = "block";
                carList.style.display = "none";
                if (map) {
                    setTimeout(() => map.getSize(), 100);
                }
            });

            listModeBtn.addEventListener("click", () => {
                listModeBtn.classList.add("active");
                mapModeBtn.classList.remove("active");
                rentMap.style.display = "none";
                carList.style.display = "block";
            });
        }

        function bindRentEvents() {
            const rentModal = new bootstrap.Modal(document.getElementById("rentModal"));
            const rentHoursInput = document.getElementById("rentHours");
            const calcPriceText = document.getElementById("calcPriceText"); // 注意ID变化
            const calcHours = document.getElementById("calcHours");
            const calcTotal = document.getElementById("calcTotal");
            const submitRentBtn = document.getElementById("submitRentBtn");

            document.addEventListener("click", (e) => {
                if (e.target.classList.contains("rent-btn")) {
                    const carId = e.target.dataset.id;
                    const carType = e.target.dataset.type;
                    const carLocation = e.target.dataset.location;
                    const carPrice = e.target.dataset.price;
                    const carOwner = e.target.dataset.owner;

                    document.getElementById("rentCarId").value = carId;
                    document.getElementById("modalCarType").textContent = carType;
                    document.getElementById("modalCarLocation").textContent = carLocation;
                    document.getElementById("modalCarPrice").textContent = carPrice;
                    document.getElementById("modalCarOwner").textContent = carOwner;
                    
                    if(calcPriceText) calcPriceText.textContent = carPrice;
                    calcHours.textContent = rentHoursInput.value;
                    calcTotal.textContent = (carPrice * rentHoursInput.value).toFixed(1);

                    rentModal.show();
                }
            });

            rentHoursInput.addEventListener("input", () => {
                const hours = rentHoursInput.value;
                // 这里的逻辑修正：价格需要从模态框或者按钮获取，不能直接读 textContent
                const price = parseFloat(document.getElementById("modalCarPrice").textContent) || 0;
                calcHours.textContent = hours;
                calcTotal.textContent = (price * hours).toFixed(1);
            });

            submitRentBtn.addEventListener("click", async () => {
                const carId = document.getElementById("rentCarId").value;
                const hours = rentHoursInput.value;
                const totalFee = calcTotal.textContent;
                const carType = document.getElementById("modalCarType").textContent;
                const carLocation = document.getElementById("modalCarLocation").textContent;
                const user_id = localStorage.getItem('user_id');

                if (!user_id) {
                    alert('请先登录');
                    window.location.href = '/login.html';
                    return;
                }

                if (!hours || hours <= 0) {
                    alert('请输入有效的租用时长');
                    return;
                }

                // 禁用按钮防止重复提交
                submitRentBtn.disabled = true;
                submitRentBtn.textContent = '提交中...';

                try {
                    const res = await fetch('/api/orders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + user_id
                        },
                        body: JSON.stringify({
                            vehicle_id: carId,
                            hours: parseInt(hours)
                        })
                    });
                    const result = await res.json();

                    if (res.ok) {
                        // 隐藏租车Modal
                        rentModal.hide();
                        
                        // 填充订单成功Modal的数据
                        document.getElementById('successOrderId').textContent = result.order_id || '-';
                        document.getElementById('successCarType').textContent = carType;
                        document.getElementById('successLocation').textContent = carLocation;
                        document.getElementById('successFee').textContent = totalFee;
                        
                        // 显示车主信息（加密显示）
                        if (result.owner_info) {
                            const ownerName = result.owner_info.name;
                            const ownerPhone = result.owner_info.phone;
                            
                            // 姓名加密：只显示姓
                            const encryptedName = ownerName.charAt(0) + '*'.repeat(ownerName.length - 1);
                            if(document.getElementById('successOwnerName')) document.getElementById('successOwnerName').textContent = encryptedName;
                            
                            // 手机号加密：显示前3位和后4位
                            const encryptedPhone = ownerPhone.substring(0, 3) + '****' + ownerPhone.substring(7);
                            if(document.getElementById('successOwnerPhone')) document.getElementById('successOwnerPhone').textContent = encryptedPhone;
                        }
                        
                        // 显示订单成功Modal
                        const successModal = new bootstrap.Modal(document.getElementById('orderSuccessModal'));
                        successModal.show();
                    } else {
                        alert(result.msg || '订单创建失败');
                    }
                } catch (error) {
                    console.error('订单创建失败', error);
                    alert('订单创建失败：' + error.message);
                } finally {
                    // 恢复按钮状态
                    submitRentBtn.disabled = false;
                    submitRentBtn.textContent = '提交订单';
                }
            });
        }
    </script>
</body>
</html>